<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crypto Predictions</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #00e676;
      --secondary: #00b0ff;
      --accent: #ff4081;
      --dark-bg: #121212;
      --darker-bg: #0a0a0a;
      --card-bg: rgba(30, 30, 47, 0.8);
      --text-light: #ffffff;
      --text-dim: rgba(255, 255, 255, 0.7);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--dark-bg);
      color: var(--text-light);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* Animated Background */
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
    }

    .particle {
      position: absolute;
      background: var(--primary);
      border-radius: 50%;
      opacity: 0.5;
      animation: float linear infinite;
    }

    @keyframes float {
      0% { transform: translateY(0) translateX(0); opacity: 0; }
      10% { opacity: 0.5; }
      90% { opacity: 0.5; }
      100% { transform: translateY(-100vh) translateX(20vw); opacity: 0; }
    }

    /* Glowing Border Animation */
    @keyframes border-glow {
      0% { box-shadow: 0 0 5px var(--primary); }
      50% { box-shadow: 0 0 20px var(--primary), 0 0 30px var(--secondary); }
      100% { box-shadow: 0 0 5px var(--primary); }
    }

    /* Header */
    nav {
      background-color: rgba(30, 30, 47, 0.9);
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(10px);
      position: relative;
      z-index: 10;
      border-bottom: 1px solid rgba(0, 230, 118, 0.3);
    }

    nav h1 {
      margin: 0;
      font-size: 24px;
      font-family: 'Orbitron', sans-serif;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: 1px;
    }

    .back-btn {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 30px;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(0, 230, 118, 0.3);
    }

    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 230, 118, 0.4);
    }

    /* Main Content */
    .container {
      max-width: 1000px;
      margin: auto;
      padding: 30px;
      position: relative;
    }

    /* Search Box */
    .search-box {
      margin: 30px 0;
      display: flex;
      gap: 10px;
      position: relative;
      animation: fadeIn 0.8s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #coinSearch {
      flex: 1;
      padding: 15px 20px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid rgba(0, 230, 118, 0.3);
      background-color: rgba(255, 255, 255, 0.1);
      color: var(--text-light);
      transition: all 0.3s ease;
    }

    #coinSearch:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(0, 230, 118, 0.3);
    }

    #coinSearch::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .search-box button {
      padding: 0 20px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .search-box button:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(0, 230, 118, 0.4);
    }

    #results {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background-color: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      z-index: 100;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 230, 118, 0.2);
      display: none;
    }

    #results div {
      padding: 12px 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    #results div:hover {
      background-color: rgba(0, 230, 118, 0.1);
      color: var(--primary);
    }

    #results div:last-child {
      border-bottom: none;
    }

    /* Coin Cards */
    .coin-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 230, 118, 0.2);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      animation: fadeIn 0.8s ease-out;
    }

    .coin-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 230, 118, 0.3);
    }

    .coin-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }

    .coin-card h2 {
      font-family: 'Orbitron', sans-serif;
      color: var(--primary);
      margin-bottom: 15px;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .coin-card p {
      margin-bottom: 10px;
      color: var(--text-dim);
    }

    .coin-card p strong {
      color: var(--text-light);
      font-weight: 500;
    }

    .coin-card ul {
      margin-top: 15px;
      list-style: none;
    }

    .coin-card ul li {
      padding: 8px 0;
      border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
      color: var(--text-dim);
    }

    .coin-card ul li:last-child {
      border-bottom: none;
    }

    .coin-card button {
      margin-top: 15px;
      padding: 8px 16px;
      background-color: rgba(255, 64, 129, 0.2);
      color: var(--accent);
      border: 1px solid var(--accent);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .coin-card button:hover {
      background-color: rgba(255, 64, 129, 0.4);
    }

    /* Price Difference Styling */
    .price-diff {
      font-weight: bold;
    }

    .price-diff.positive {
      color: var(--primary);
    }

    .price-diff.negative {
      color: var(--accent);
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 25px;
      background-color: rgba(30, 30, 47, 0.9);
      color: var(--text-dim);
      margin-top: 40px;
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(0, 230, 118, 0.2);
    }

    footer span {
      color: var(--primary);
    }

    /* Responsive */
    @media (max-width: 768px) {
      nav {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .container {
        padding: 20px;
      }

      .search-box {
        flex-direction: column;
      }

      .search-box button {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- Animated Background Particles -->
  <div class="particles" id="particles"></div>

  <nav>
    <h1><i class="fas fa-chart-line"></i> Crypto Price Forecasts</h1>
    <a href="http://localhost:5000/dashboard.html" class="back-btn">
      <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>
  </nav>

  <div class="container">
    <form method="POST" action="/add-coin" class="search-box" onsubmit="return confirmAdd();">
      <input type="text" id="coinSearch" name="coin_id" placeholder="Search for a coin (e.g. bitcoin)..." required autocomplete="off">
      <button type="submit"><i class="fas fa-plus"></i> Add Coin</button>
      <div id="results"></div>
    </form>

    <div id="coinDetails"></div>

    {% for p in predictions %}
      <div class="coin-card">
        <h2><i class="fas fa-coins"></i> {{ p.coin }}</h2>
        {% if p.error %}
          <p style="color: var(--accent);"><strong>Error:</strong> {{ p.error }}</p>   
        {% else %}
          <p><strong>Current Price:</strong> ₹{{ p.actual_price }}</p>
          {% if p.actual_price != 0 %}
            {% set pct_diff = ((p.predicted_price - p.actual_price) / p.actual_price * 100) | round(2) %}
            {% set diff_class = 'positive' if pct_diff >= 0 else 'negative' %}
          {% else %}
            {% set pct_diff = 'N/A' %}
            {% set diff_class = '' %}
          {% endif %}
          <p>
            <strong>Next Hour Prediction ({{ p.timestamp }}):</strong> 
            ₹{{ p.predicted_price | round(2) }} 
            <span class="price-diff {{ diff_class }}">
              {% if pct_diff != 'N/A' %}({{ pct_diff }}%){% endif %}
            </span>
          </p>
          <p><strong>Confidence:</strong> 
            <span style="color: {% if p.confidence > 70 %}var(--primary){% elif p.confidence > 40 %}var(--secondary){% else %}var(--accent){% endif %}">
              {{ p.confidence }}%
            </span>
          </p>
          <p><strong>Last Updated:</strong> {{ p.last_updated }}</p>
          <form method="POST" action="/delete-coin/{{ p.coin | lower }}">
            <button type="submit" onclick="return confirm('Delete {{ p.coin }} from dashboard?')">
              <i class="fas fa-trash"></i> Remove
            </button>
          </form>

          <h4><i class="fas fa-history"></i> Prediction History (last 5 hours):</h4>
          <ul>
            {% for h in p.history %}
              <li>
                {{ h.timestamp }} — 
                ₹{{ h.predicted_price | round(2) }} — 
                ₹{{ h.actual_price | round(2) }} — 
                <span style="color: {% if h.accuracy > 70 %}var(--primary){% elif h.accuracy > 40 %}var(--secondary){% else %}var(--accent){% endif %}">
                  {{ h.accuracy }}%
                </span>
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <footer>
    Built Brick by brick <i class="fas fa-heart" style="color: var(--accent);"></i> by <span>Joshi Karan</span> · {{ now.year }}
  </footer>

  <script>
    // Create animated particles
    function createParticles() {
      const particlesContainer = document.getElementById('particles');
      const particleCount = window.innerWidth < 768 ? 30 : 50;
      
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.classList.add('particle');
        
        // Random size between 1px and 3px
        const size = Math.random() * 2 + 1;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        
        // Random position
        particle.style.left = `${Math.random() * 100}vw`;
        particle.style.top = `${Math.random() * 100}vh`;
        
        // Random animation duration between 10s and 20s
        const duration = Math.random() * 10 + 10;
        particle.style.animationDuration = `${duration}s`;
        
        // Random delay
        particle.style.animationDelay = `${Math.random() * 10}s`;
        
        particlesContainer.appendChild(particle);
      }
    }

    // Initialize particles
    createParticles();

    // Coin search functionality
    const input = document.getElementById("coinSearch");
    const results = document.getElementById("results");
    const coinDetails = document.getElementById("coinDetails");
    let selectedCoin = null;

    input.addEventListener("input", async () => {
      const query = input.value.trim().toLowerCase();
      if (!query) {
        results.style.display = "none";
        return;
      }

      try {
        const res = await fetch(`https://api.coingecko.com/api/v3/search?query=${query}`);
        const data = await res.json();
        results.innerHTML = "";

        if (data.coins && data.coins.length > 0) {
          data.coins.slice(0, 5).forEach((coin) => {
            const div = document.createElement("div");
            div.innerHTML = `
              <i class="fas fa-coins" style="color: var(--primary); margin-right: 8px;"></i>
              ${coin.name} <small>(${coin.symbol.toUpperCase()})</small>
            `;
            div.onclick = () => {
              input.value = coin.id;
              results.style.display = "none";
              fetchCoinDetails(coin.id);
            };
            results.appendChild(div);
          });
          results.style.display = "block";
        } else {
          results.style.display = "none";
        }
      } catch (error) {
        console.error("Error fetching coins:", error);
        results.style.display = "none";
      }
    });

    // Close results when clicking outside
    document.addEventListener('click', (e) => {
      if (!input.contains(e.target) && !results.contains(e.target)) {
        results.style.display = "none";
      }
    });

    async function fetchCoinDetails(coinId) {
      coinDetails.innerHTML = `
        <div class="coin-card" style="animation: none;">
          <div style="display: flex; justify-content: center; padding: 20px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--primary);"></i>
          </div>
        </div>
      `;
      
      try {
        const res = await fetch(`https://api.coingecko.com/api/v3/coins/markets?vs_currency=inr&ids=${coinId}`);
        const [coin] = await res.json();
        if (!coin) {
          coinDetails.innerHTML = `
            <div class="coin-card" style="color: var(--accent);">
              <i class="fas fa-exclamation-triangle"></i> Coin not found
            </div>
          `;
          return;
        }

        selectedCoin = coin;

        coinDetails.innerHTML = `
          <div class="coin-card">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
              <img src="${coin.image}" width="40" style="border-radius: 50%;">
              <div>
                <h2>${coin.name} (${coin.symbol.toUpperCase()})</h2>
                <p style="color: var(--text-dim);">Rank: #${coin.market_cap_rank || 'N/A'}</p>
              </div>
            </div>
            <p><strong>Current Price:</strong> ₹${coin.current_price.toLocaleString("en-IN")}</p>
            <p><strong>Market Cap:</strong> ₹${coin.market_cap.toLocaleString("en-IN")}</p>
            <p><strong>24h Change:</strong> 
              <span style="color: ${coin.price_change_percentage_24h >= 0 ? 'var(--primary)' : 'var(--accent)'}">
                ${coin.price_change_percentage_24h?.toFixed(2) || 'N/A'}%
              </span>
            </p>
            <p style="margin-top: 15px; color: var(--primary);">
              <i class="fas fa-check-circle"></i> Ready to add to your dashboard
            </p>
          </div>
        `;
      } catch (e) {
        coinDetails.innerHTML = `
          <div class="coin-card" style="color: var(--accent);">
            <i class="fas fa-exclamation-triangle"></i> Error fetching coin info
          </div>
        `;
        console.error(e.message);
      }
    }

    function confirmAdd() {
      if (!selectedCoin) {
        alert("Please select a coin from the dropdown first.");
        return false;
      }
      return true;
    }

    // Add animation to cards when they come into view
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.style.animation = "fadeIn 0.8s ease-out forwards";
          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.1 });

    document.querySelectorAll('.coin-card').forEach(card => {
      observer.observe(card);
    });
  </script>
</body>
</html>